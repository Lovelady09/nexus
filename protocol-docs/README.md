# Nexus Protocol Documentation

This directory contains documentation for the Nexus BBS protocol.

## Overview

Nexus uses a custom framed JSON protocol over TLS. The protocol is designed to be:

- **Simple** - JSON payloads, human-readable for debugging
- **Secure** - Mandatory TLS with certificate verification
- **Efficient** - Framed messages with per-type size limits

## Ports

| Port | Purpose | Description |
|------|---------|-------------|
| 7500 | BBS | Main protocol (chat, users, news, file browsing) |
| 7501 | Transfers | File uploads and downloads |

Both ports use the same TLS certificate and frame format. The transfer port is communicated to clients in the `LoginResponse`.

## TLS

All connections require TLS 1.2 or higher. Servers auto-generate self-signed certificates on first run.

**Certificate Verification (TOFU):**
1. On first connection, client stores the server's certificate fingerprint (SHA-256)
2. On subsequent connections, client verifies the fingerprint matches
3. If mismatch, client warns user (possible MITM attack or certificate regeneration)

## Frame Format

Every message uses this frame format:

```
NX|<type_length>|<message_type>|<message_id>|<payload_length>|<json_payload>\n
```

| Field | Format | Description |
|-------|--------|-------------|
| Magic | `NX\|` | Protocol identifier (3 bytes) |
| Type Length | ASCII decimal | Length of message type string (1-3 digits) |
| Delimiter | `\|` | Field separator |
| Message Type | ASCII string | Message type (e.g., `Handshake`, `ChatSend`) |
| Delimiter | `\|` | Field separator |
| Message ID | Hex string | 12-character ID for request-response correlation |
| Delimiter | `\|` | Field separator |
| Payload Length | ASCII decimal | Length of JSON payload in bytes |
| Delimiter | `\|` | Field separator |
| JSON Payload | UTF-8 JSON | Message data |
| Terminator | `\n` | Newline (1 byte) |

### Example

A handshake message:

```
NX|9|Handshake|a1b2c3d4e5f6|20|{"version":"0.5.0"}\n
```

Breaking it down:
- `NX|` - Magic bytes
- `9` - Type length ("Handshake" is 9 characters)
- `Handshake` - Message type
- `a1b2c3d4e5f6` - Message ID (12 hex characters)
- `20` - Payload length (20 bytes)
- `{"version":"0.5.0"}` - JSON payload
- `\n` - Terminator

### Message ID

The message ID is a 12-character hexadecimal string generated by the sender. It serves two purposes:

1. **Request-Response Correlation** - Responses include the same message ID as the request
2. **Logging** - Helps trace messages through the system

The sender generates the ID; the receiver echoes it back in the response.

### Payload Limits

Each message type has a maximum payload size to prevent denial-of-service attacks. Unknown message types are rejected. Limits are enforced before reading the payload.

## Connection Flow

```
Client                                        Server
   │                                             │
   │  ─────── TLS Handshake ───────────────►    │
   │  ◄─────────────────────────────────────    │
   │                                             │
   │  Handshake { version }                      │
   │ ───────────────────────────────────────►    │
   │                                             │
   │         HandshakeResponse { version }       │
   │ ◄───────────────────────────────────────    │
   │                                             │
   │  Login { username, password, ... }          │
   │ ───────────────────────────────────────►    │
   │                                             │
   │         LoginResponse { session_id, ... }   │
   │ ◄───────────────────────────────────────    │
   │                                             │
   │  ─────── Session Established ──────────    │
   │                                             │
```

After login, clients can send commands and receive broadcasts until disconnection.

## Protocol Version

The protocol version follows [Semantic Versioning](https://semver.org/):

- **Major** - Breaking changes (must match between client and server)
- **Minor** - New features (client minor ≤ server minor)
- **Patch** - Bug fixes (ignored for compatibility)

Current version: `0.5.0`

## Documents

| Document | Description |
|----------|-------------|
| [01-handshake.md](01-handshake.md) | Handshake and version negotiation |
| [02-login.md](02-login.md) | Authentication and session establishment |
| [03-chat.md](03-chat.md) | Chat messages and topics |
| [04-users.md](04-users.md) | User list and presence |
| [05-messaging.md](05-messaging.md) | Private messages and broadcasts |
| [06-news.md](06-news.md) | News posts |
| [07-files.md](07-files.md) | File browsing and management |
| [08-transfers.md](08-transfers.md) | File upload and download (port 7501) |
| [09-admin.md](09-admin.md) | User and server administration |
| [10-errors.md](10-errors.md) | Error handling |