name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/nexusd

jobs:
  # Build Linux client packages (deb, rpm, appimage)
  build-linux-client:
    name: Build Linux Client (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            arch: x64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Remove Microsoft repos that cause 403 errors on ARM runners
          sudo rm -f /etc/apt/sources.list.d/microsoft*.list
          sudo rm -f /etc/apt/sources.list.d/azure*.list
          sudo apt-get update
          sudo apt-get install -y libasound2-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: linux-${{ matrix.arch }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-${{ matrix.arch }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: linux-${{ matrix.arch }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-${{ matrix.arch }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: linux-${{ matrix.arch }}-client-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-${{ matrix.arch }}-client-cargo-build-

      - name: Cache cargo-bundle
        id: cache-cargo-bundle
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-bundle
          key: cargo-bundle-linux-${{ matrix.arch }}

      - name: Install cargo-bundle
        if: steps.cache-cargo-bundle.outputs.cache-hit != 'true'
        run: cargo install --git https://github.com/zquestz/cargo-bundle --force

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build deb package
        working-directory: nexus-client
        run: cargo bundle --release --format deb

      - name: Build appimage package
        working-directory: nexus-client
        run: cargo bundle --release --format appimage

      - name: Collect artifacts
        run: |
          mkdir -p dist
          mv target/release/bundle/deb/*.deb dist/nexus-client-${{ steps.version.outputs.VERSION }}-linux-${{ matrix.arch }}.deb
          mv target/release/bundle/appimage/*.AppImage dist/nexus-client-${{ steps.version.outputs.VERSION }}-linux-${{ matrix.arch }}.AppImage

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-client-${{ matrix.arch }}
          path: dist/*

  # Build Linux server
  build-linux-server:
    name: Build Linux Server (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            arch: x64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: linux-${{ matrix.arch }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-${{ matrix.arch }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: linux-${{ matrix.arch }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-${{ matrix.arch }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: linux-${{ matrix.arch }}-server-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-${{ matrix.arch }}-server-cargo-build-

      - name: Build server
        run: cargo build --release --package nexus-server

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Package server
        run: |
          mkdir -p dist/nexusd
          cp target/release/nexusd dist/nexusd/
          cp README.md LICENSE dist/nexusd/
          cp nexus-server/dist/nexusd.service dist/nexusd/
          cd dist
          tar -czvf nexusd-${{ steps.version.outputs.VERSION }}-linux-${{ matrix.arch }}.tar.gz nexusd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-server-${{ matrix.arch }}
          path: dist/*.tar.gz

  # Build macOS client (arm64) - native on arm runner
  build-macos-client-arm64:
    name: Build macOS Client (arm64)
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: macos-arm64-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: macos-arm64-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: macos-arm64-client-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-client-cargo-build-

      - name: Cache cargo-bundle
        id: cache-cargo-bundle
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-bundle
          key: cargo-bundle-macos-arm64

      - name: Install cargo-bundle
        if: steps.cache-cargo-bundle.outputs.cache-hit != 'true'
        run: cargo install --git https://github.com/zquestz/cargo-bundle --force

      - name: Configure for macOS bundle
        working-directory: nexus-client
        run: |
          # Add ICNS icon for macOS builds
          sed -i '' 's/icon = \["assets\/macos\/nexus.png", "assets\/windows\/nexus.ico"\]/icon = ["assets\/macos\/nexus.png", "assets\/macos\/nexus.icns", "assets\/windows\/nexus.ico"]/' Cargo.toml
          # Rename binary to Nexus for macOS builds
          sed -i '' 's/name = "nexus"/name = "Nexus"/' Cargo.toml

      - name: Build app bundle
        working-directory: nexus-client
        run: cargo bundle --release

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: macos-client-arm64-binary
          path: target/release/Nexus

      - name: Upload app bundle
        uses: actions/upload-artifact@v4
        with:
          name: macos-client-app-bundle
          path: target/release/bundle/osx/Nexus BBS.app

  # Build macOS client (x64) - cross-compile on arm runner
  build-macos-client-x64:
    name: Build macOS Client (x64)
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: macos-arm64-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: macos-arm64-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: macos-x64-client-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-x64-client-cargo-build-

      - name: Build client (x64)
        run: cargo build --release --package nexus-client --target x86_64-apple-darwin

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: macos-client-x64-binary
          path: target/x86_64-apple-darwin/release/nexus

  # Merge macOS client binaries into universal binary and create DMG
  build-macos-client-universal:
    name: Build macOS Client (universal)
    runs-on: macos-14
    needs: [build-macos-client-arm64, build-macos-client-x64]
    timeout-minutes: 15
    steps:
      - name: Download app bundle
        uses: actions/download-artifact@v4
        with:
          name: macos-client-app-bundle
          path: Nexus BBS.app

      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: macos-client-arm64-binary
          path: binaries/arm64

      - name: Download x64 binary
        uses: actions/download-artifact@v4
        with:
          name: macos-client-x64-binary
          path: binaries/x64

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create universal binary and replace in bundle
        run: |
          lipo -create \
            -output "Nexus BBS.app/Contents/MacOS/Nexus" \
            binaries/arm64/Nexus \
            binaries/x64/nexus
          chmod +x "Nexus BBS.app/Contents/MacOS/Nexus"
          file "Nexus BBS.app/Contents/MacOS/Nexus"

      - name: Clear extended attributes
        run: xattr -cr "Nexus BBS.app"

      # Ad-hoc signing provides a valid signature without an Apple Developer account.
      # It helps with some Gatekeeper checks but isn't notarized.
      # For full Gatekeeper bypass, use a Developer ID ($99/year):
      #   codesign --force --options runtime --sign "Developer ID Application: Name (TEAMID)" ...
      #   xcrun notarytool submit *.dmg --apple-id "..." --password "..." --team-id "..." --wait
      #   xcrun stapler staple *.dmg
      - name: Ad-hoc code sign
        run: |
          # Sign all nested components first (inside-out signing)
          find "Nexus BBS.app" -type f -perm +111 -exec codesign --force --deep --sign - {} \; 2>/dev/null || true
          # Sign the main binary
          codesign --force --sign - "Nexus BBS.app/Contents/MacOS/Nexus"
          # Sign the app bundle
          codesign --force --sign - "Nexus BBS.app"
          # Verify the signature
          codesign --verify --verbose "Nexus BBS.app"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          mkdir -p dist
          create-dmg \
            --volname "Nexus BBS" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Nexus BBS.app" 200 190 \
            --hide-extension "Nexus BBS.app" \
            --app-drop-link 600 185 \
            "dist/nexus-client-${{ steps.version.outputs.VERSION }}-macos-universal.dmg" \
            "Nexus BBS.app"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-client
          path: dist/*

  # Build macOS server (both architectures)
  build-macos-server:
    name: Build macOS Server (universal)
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: macos-arm64-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: macos-arm64-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: macos-server-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-server-cargo-build-

      - name: Build server (arm64)
        run: cargo build --release --package nexus-server --target aarch64-apple-darwin

      - name: Build server (x64)
        run: cargo build --release --package nexus-server --target x86_64-apple-darwin

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Package server (x64)
        run: |
          mkdir -p dist/nexusd
          cp target/x86_64-apple-darwin/release/nexusd dist/nexusd/
          cp README.md LICENSE dist/nexusd/
          cd dist
          tar -czvf nexusd-${{ steps.version.outputs.VERSION }}-macos-x64.tar.gz nexusd
          rm -rf nexusd

      - name: Package server (arm64)
        run: |
          mkdir -p dist/nexusd
          cp target/aarch64-apple-darwin/release/nexusd dist/nexusd/
          cp README.md LICENSE dist/nexusd/
          cd dist
          tar -czvf nexusd-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz nexusd
          rm -rf nexusd

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-server
          path: dist/*

  # Build Windows client
  build-windows-client:
    name: Build Windows Client
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: windows-x64-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-x64-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: windows-x64-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-x64-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: windows-client-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-client-cargo-build-

      - name: Build client
        run: cargo build --release --package nexus-client --target x86_64-pc-windows-msvc

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Cache cargo-bundle
        id: cache-cargo-bundle
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-bundle.exe
          key: cargo-bundle-windows-x64

      - name: Install cargo-bundle
        if: steps.cache-cargo-bundle.outputs.cache-hit != 'true'
        run: cargo install --git https://github.com/zquestz/cargo-bundle --force

      - name: Create MSI installer
        working-directory: nexus-client
        run: cargo bundle --target x86_64-pc-windows-msvc --format wxsmsi --release

      - name: Collect client artifact
        shell: bash
        run: |
          mkdir -p dist
          mv target/x86_64-pc-windows-msvc/release/bundle/wxsmsi/bin/Release/*.msi \
             dist/nexus-client-${{ steps.version.outputs.VERSION }}-windows-x64.msi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-client
          path: dist/*.msi

  # Build Windows server
  build-windows-server:
    name: Build Windows Server
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: windows-x64-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-x64-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: windows-x64-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-x64-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: windows-server-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-server-cargo-build-

      - name: Build server
        run: cargo build --release --package nexus-server

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Package server
        shell: bash
        run: |
          mkdir -p dist/nexusd
          cp target/release/nexusd.exe dist/nexusd/
          cp README.md LICENSE dist/nexusd/
          cd dist
          7z a -tzip nexusd-${{ steps.version.outputs.VERSION }}-windows-x64.zip nexusd

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-server
          path: dist/*.zip

  # Create GitHub release with all artifacts
  release:
    name: Create Release
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    needs: [build-linux-client, build-linux-server, build-macos-client-universal, build-macos-server, build-windows-client, build-windows-server]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download Linux client artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: linux-client-*

      - name: Download Linux server artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: linux-server-*

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: macos-client
      
      - name: Download macOS server artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: macos-server

      - name: Download Windows client artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: windows-client

      - name: Download Windows server artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: windows-server

      - name: Collect release files
        run: |
          mkdir -p release

          # Linux client packages
          cp artifacts/linux-client-x64/* release/
          cp artifacts/linux-client-arm64/* release/

          # Linux server
          cp artifacts/linux-server-x64/* release/
          cp artifacts/linux-server-arm64/* release/

          # macOS
          cp artifacts/macos-client/* release/
          cp artifacts/macos-server/* release/

          # Windows
          cp artifacts/windows-client/* release/
          cp artifacts/windows-server/* release/

          echo "Release artifacts:"
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          echo "Checksums:"
          cat SHA256SUMS.txt

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: release/*
          body: |
            ## Docker

            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/nexusd:${{ steps.version.outputs.VERSION }}
            ```

            ## Downloads

            ### Client (Nexus BBS)

            #### macOS
            | Architecture | Download |
            |--------------|----------|
            | Universal (Intel + Apple Silicon) | `nexus-client-${{ steps.version.outputs.VERSION }}-macos-universal.dmg` |

            #### Windows
            | Architecture | Download |
            |--------------|----------|
            | x64 (Installer) | `nexus-client-${{ steps.version.outputs.VERSION }}-windows-x64.msi` |

            #### Linux
            | Format | x64 | ARM64 |
            |--------|-----|-------|
            | AppImage (all distros) | `nexus-client-${{ steps.version.outputs.VERSION }}-linux-x64.AppImage` | `nexus-client-${{ steps.version.outputs.VERSION }}-linux-arm64.AppImage` |
            | Debian/Ubuntu (.deb) | `nexus-client-${{ steps.version.outputs.VERSION }}-linux-x64.deb` | `nexus-client-${{ steps.version.outputs.VERSION }}-linux-arm64.deb` |

            > **Fedora/RHEL users:** Use the AppImage. RPM packages are not available due to [cargo-bundle not implementing RPM support](https://github.com/burtonageo/cargo-bundle/issues/92).

            ### Server (nexusd)

            | Platform | x64 | ARM64 |
            |----------|-----|-------|
            | macOS | `nexusd-${{ steps.version.outputs.VERSION }}-macos-x64.tar.gz` | `nexusd-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz` |
            | Windows | `nexusd-${{ steps.version.outputs.VERSION }}-windows-x64.zip` | â€” |
            | Linux | `nexusd-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz` | `nexusd-${{ steps.version.outputs.VERSION }}-linux-arm64.tar.gz` |

            ### Verification

            Verify your download with the SHA256 checksums in `SHA256SUMS.txt`:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

  # Build Docker image (amd64) - native build
  build-docker-amd64:
    name: Build Docker Image (amd64)
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:amd64-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=docker-amd64
          cache-to: type=gha,mode=max,scope=docker-amd64

  # Build Docker image (arm64) - native build
  build-docker-arm64:
    name: Build Docker Image (arm64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 45
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:arm64-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=docker-arm64
          cache-to: type=gha,mode=max,scope=docker-arm64

  # Merge Docker manifests into multi-arch image
  docker-manifest:
    name: Create Docker Manifest
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-docker-amd64, build-docker-arm64]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Create and push manifest
        run: |
          # Get all tags from metadata
          TAGS="${{ steps.meta.outputs.tags }}"

          # For each tag, create a manifest combining both architectures
          for TAG in $TAGS; do
            echo "Creating manifest for $TAG"
            docker buildx imagetools create -t "$TAG" \
              "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:amd64-${{ github.sha }}" \
              "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:arm64-${{ github.sha }}"
          done

      - name: Clean up arch-specific tags
        run: |
          # Note: ghcr.io doesn't support tag deletion via API
          # The arch-specific tags (amd64-SHA, arm64-SHA) will remain but are harmless
          echo "Multi-arch manifest created successfully"
          echo "Arch-specific tags will be cleaned up by registry retention policy"
